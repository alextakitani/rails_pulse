#!/usr/bin/env bash

# Rails Pulse Development Server
# Builds assets and starts the Rails server with optional tracking modes

set -e

# Parse arguments
VERBOSE=false
STANDALONE_DASHBOARD=false
RAILS_ARGS=()

for arg in "$@"; do
  case $arg in
    --verbose|-v)
      VERBOSE=true
      shift
      ;;
    --standalone)
      STANDALONE_DASHBOARD=true
      shift
      ;;
    --help|-h)
      echo "Rails Pulse Development Server"
      echo ""
      echo "Usage: ./bin/dev [options] [rails server options]"
      echo ""
      echo "Options:"
      echo "  -v, --verbose      Show detailed output from asset building and watching"
      echo "  --standalone       Run standalone dashboard on port 3001"
      echo "  -h, --help         Show this help message"
      echo ""
      echo "Dashboard Modes:"
      echo "  default     - Dashboard embedded in main app (async tracking)"
      echo "  standalone  - Dashboard runs as separate process (production architecture)"
      echo ""
      echo "Examples:"
      echo "  ./bin/dev                    # Start embedded dashboard with async tracking"
      echo "  ./bin/dev --standalone       # Run standalone dashboard only"
      echo "  ./bin/dev --verbose          # Start with detailed output"
      echo "  ./bin/dev -p 3001            # Start on port 3001"
      exit 0
      ;;
    *)
      RAILS_ARGS+=("$arg")
      shift
      ;;
  esac
done

echo "ğŸš€ Starting Rails Pulse development server..."

# We're already in the Rails Pulse root directory
ROOT_DIR="$(pwd)"
DUMMY_DIR="$ROOT_DIR/test/dummy"

# Check if npm is available
if ! command -v npm &> /dev/null; then
  echo "âŒ npm is required but not installed. Please install Node.js and npm."
  exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
  echo "ğŸ“¦ Installing npm dependencies..."
  if [ "$VERBOSE" = true ]; then
    npm install
  else
    npm install --silent
  fi
fi

# Start asset watching in background (unless running standalone dashboard)
if [ "$STANDALONE_DASHBOARD" = false ]; then
  if [ "$VERBOSE" = true ]; then
    echo "ğŸ‘€ Starting asset watcher..."
    RAILS_PULSE_VERBOSE=true npm run watch &
  else
    echo "ğŸ‘€ Asset watcher started"
    npm run watch > /dev/null 2>&1 &
  fi
  WATCH_PID=$!

  # Function to cleanup background processes
  cleanup() {
    echo "ğŸ›‘ Stopping asset watcher..."
    kill $WATCH_PID 2>/dev/null || true
    exit
  }

  # Trap cleanup on script exit
  trap cleanup EXIT INT TERM

  # Initial build
  if [ "$VERBOSE" = true ]; then
    echo "ğŸ”¨ Building Rails Pulse assets..."
    RAILS_PULSE_VERBOSE=true npm run build
  else
    echo "ğŸ”¨ Assets built successfully"
    npm run build > /dev/null 2>&1
  fi
fi

# Run in the appropriate mode
if [ "$STANDALONE_DASHBOARD" = true ]; then
  # Standalone dashboard mode
  echo "ğŸ“Š Mode: STANDALONE DASHBOARD"
  echo "ğŸŒ Starting standalone dashboard on port 3001..."
  echo ""
  echo "   The dashboard will read from the dummy app's database."
  echo "   Make sure to run the main app separately with: ./bin/dev"
  echo ""

  # Point to dummy app's database
  export DATABASE_URL="sqlite3:$DUMMY_DIR/db/development.sqlite3"

  cd "$ROOT_DIR"
  exec bundle exec rackup lib/rails_pulse_server.ru -p 3001 -o 0.0.0.0

else
  # Embedded dashboard mode
  echo "ğŸ“Š Starting RailsPulse dashboard (embedded mode)"
  echo "   Dashboard available at /rails_pulse"
  echo ""
  echo "ğŸŒ Starting Rails server..."
  cd "$DUMMY_DIR"
  exec ./bin/rails server "${RAILS_ARGS[@]}"
fi
