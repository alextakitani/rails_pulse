#!/usr/bin/env ruby
# frozen_string_literal: true

# Smoke test script for Rails Pulse install and upgrade generators
# Verifies that generators run successfully and create expected files

require "fileutils"

class GeneratorTester
  attr_reader :test_dir, :errors

  def initialize
    @test_dir = File.expand_path("../test/dummy", __dir__)
    @errors = []
    @passed = 0
    @failed = 0
    @original_files = {}
  end

  def run
    puts "\n" + "=" * 80
    puts "Rails Pulse Generator Smoke Tests"
    puts "=" * 80

    cleanup_before_tests

    # Run all tests
    test_single_database_install
    test_single_database_upgrade
    cleanup_between_tests
    test_separate_database_install
    test_separate_database_upgrade

    # Final cleanup
    cleanup_after_tests

    # Print summary
    print_summary
  end

  private

  def cleanup_before_tests
    section "Cleaning up before tests"
    backup_existing_files
    full_cleanup
  end

  def cleanup_between_tests
    section "Cleaning up between tests"
    full_cleanup
  end

  def cleanup_after_tests
    section "Cleaning up after tests"
    full_cleanup
    restore_original_files
    puts "  ✓ Working directory is clean"
  end

  def backup_existing_files
    Dir.chdir(test_dir) do
      files_to_backup = [
        "config/initializers/rails_pulse.rb",
        "db/rails_pulse_schema.rb",
        "db/rails_pulse_migrate"
      ]

      files_to_backup.each do |file|
        if File.exist?(file) || Dir.exist?(file)
          if File.directory?(file)
            @original_files[file] = :directory
          else
            @original_files[file] = File.read(file)
          end
        end
      end

      # Backup any existing rails_pulse migrations
      Dir.glob("db/migrate/*rails_pulse*.rb").each do |migration|
        @original_files[migration] = File.read(migration)
      end
    end
  end

  def restore_original_files
    Dir.chdir(test_dir) do
      @original_files.each do |file, content|
        if content == :directory
          FileUtils.mkdir_p(file) unless Dir.exist?(file)
        else
          FileUtils.mkdir_p(File.dirname(file))
          File.write(file, content)
        end
      end
      puts "  ✓ Restored #{@original_files.size} original file(s)" if @original_files.any?
    end
  end

  def full_cleanup
    Dir.chdir(test_dir) do
      # Drop and recreate test database for clean state
      run_command "bin/rails db:drop db:create RAILS_ENV=test"

      # Remove all generated files
      FileUtils.rm_f("config/initializers/rails_pulse.rb")
      FileUtils.rm_f("db/rails_pulse_schema.rb")
      FileUtils.rm_rf("db/rails_pulse_migrate")

      # Remove any generated migrations
      Dir.glob("db/migrate/*rails_pulse*.rb").each { |f| FileUtils.rm_f(f) }
      Dir.glob("db/migrate/*test_feature*.rb").each { |f| FileUtils.rm_f(f) }
      Dir.glob("db/migrate/*another_feature*.rb").each { |f| FileUtils.rm_f(f) }

      # Remove development database if exists
      FileUtils.rm_f("storage/development_rails_pulse.sqlite3")

      # Clean up test migrations from gem directory
      gem_migrate_dir = File.expand_path("../../db/rails_pulse_migrate", test_dir)
      if Dir.exist?(gem_migrate_dir)
        Dir.glob("#{gem_migrate_dir}/*test*.rb").each { |f| FileUtils.rm_f(f) }
        Dir.glob("#{gem_migrate_dir}/*another*.rb").each { |f| FileUtils.rm_f(f) }
      end
    end
  end

  def test_single_database_install
    section "Test 1: Single Database Install"

    Dir.chdir(test_dir) do
      # Run install generator
      output = run_command("bin/rails generate rails_pulse:install", capture: true)

      # Verify files created
      assert_file_exists "db/rails_pulse_schema.rb", "Schema file created"
      assert_file_exists "db/rails_pulse_migrate/.keep", "Migration directory created"
      assert_file_exists "config/initializers/rails_pulse.rb", "Initializer created"
      assert_file_matches "db/migrate/*install_rails_pulse*.rb", "Installation migration created"

      # Verify output
      assert_output_includes output, "Single Database Setup", "Correct setup type"

      # Run migration
      run_command "bin/rails db:migrate RAILS_ENV=test"

      # Verify tables created
      verify_tables_exist("Tables created successfully")
    end
  end

  def test_single_database_upgrade
    section "Test 2: Single Database Upgrade"

    # Create test migration in gem directory
    gem_migration_path = File.join(test_dir, "../../db/rails_pulse_migrate/20251019000000_add_test_feature.rb")
    FileUtils.mkdir_p(File.dirname(gem_migration_path))
    File.write(gem_migration_path, <<~RUBY)
      class AddTestFeature < ActiveRecord::Migration[7.0]
        def change
          add_column :rails_pulse_routes, :test_column, :string, comment: "Test column for upgrade testing"
        end
      end
    RUBY

    Dir.chdir(test_dir) do
      # Run upgrade generator
      run_command "bin/rails generate rails_pulse:upgrade"

      # Verify migration was copied (generator copies with same timestamp)
      if Dir.glob("db/migrate/*add_test_feature*.rb").any?
        pass "Migration copied to db/migrate"

        # Run migration
        run_command "bin/rails db:migrate RAILS_ENV=test"

        # Verify column added
        result = run_command("bin/rails runner -e test \"puts RailsPulse::Route.column_names.include?('test_column')\"", capture: true)
        if result.strip == "true"
          pass "Upgrade migration applied successfully"
        else
          fail "Upgrade migration did not apply correctly"
        end
      else
        pass "No new migrations (Rails Pulse is up to date)"
      end
    end
  end

  def test_separate_database_install
    section "Test 3: Separate Database Install"

    Dir.chdir(test_dir) do
      output = run_command("bin/rails generate rails_pulse:install --database=separate", capture: true)

      assert_file_exists "db/rails_pulse_schema.rb", "Schema file created"
      assert_file_exists "db/rails_pulse_migrate/.keep", "Migration directory created"
      assert_file_exists "config/initializers/rails_pulse.rb", "Initializer created"
      assert_no_file_matches "db/migrate/*install_rails_pulse*.rb", "No installation migration (correct for separate DB)"

      assert_output_includes output, "Separate Database Setup", "Correct setup type"
      assert_output_includes output, "rails_pulse:", "Database config instructions"

      # Run db:prepare
      run_command "bin/rails db:prepare RAILS_ENV=test"

      verify_tables_exist("Tables created successfully")
    end
  end

  def test_separate_database_upgrade
    section "Test 4: Separate Database Upgrade"

    # Create test migration in gem directory
    gem_migration_path = File.join(test_dir, "../../db/rails_pulse_migrate/20251019000001_add_another_feature.rb")
    File.write(gem_migration_path, <<~RUBY)
      class AddAnotherFeature < ActiveRecord::Migration[7.0]
        def change
          add_column :rails_pulse_queries, :test_column, :string, comment: "Test column for separate database upgrade"
        end
      end
    RUBY

    Dir.chdir(test_dir) do
      # Run upgrade generator
      run_command "bin/rails generate rails_pulse:upgrade --database=separate"

      # Verify migration was copied
      if Dir.glob("db/rails_pulse_migrate/*add_another_feature*.rb").any?
        pass "Migration copied to db/rails_pulse_migrate"
        pass "Upgrade generator completed successfully"
      else
        pass "No new migrations (Rails Pulse is up to date)"
      end
    end
  end

  def run_command(cmd, capture: false)
    if capture
      `#{cmd} 2>&1`
    else
      system(cmd, out: File::NULL, err: File::NULL)
      ""
    end
  end

  def assert_file_exists(pattern, description)
    files = Dir.glob(File.join(test_dir, pattern))
    if files.any?
      pass description
    else
      fail "#{description} - File not found: #{pattern}"
    end
  end

  def assert_no_file_matches(pattern, description)
    files = Dir.glob(File.join(test_dir, pattern))
    if files.empty?
      pass description
    else
      fail "#{description} - Unexpected file found: #{files.first}"
    end
  end

  def assert_file_matches(pattern, description)
    assert_file_exists(pattern, description)
  end

  def assert_output_includes(output, text, description)
    if output.include?(text)
      pass description
    else
      fail "#{description} - Expected output to include '#{text}'"
    end
  end

  def verify_tables_exist(description)
    Dir.chdir(test_dir) do
      result = run_command(
        "bin/rails runner -e test \"puts RailsPulse::Route.table_exists? && RailsPulse::Query.table_exists? && RailsPulse::Request.table_exists?\"",
        capture: true
      )

      if result.strip == "true"
        pass description
      else
        fail "#{description} - Tables do not exist"
      end
    end
  end

  def section(title)
    puts "\n#{title}"
    puts "-" * 80
  end

  def pass(message)
    @passed += 1
    puts "  ✓ #{message}"
  end

  def fail(message)
    @failed += 1
    @errors << message
    puts "  ✗ #{message}"
  end

  def print_summary
    puts "\n" + "=" * 80
    puts "Test Summary"
    puts "=" * 80
    puts "Passed: #{@passed}"
    puts "Failed: #{@failed}"

    if @failed > 0
      puts "\nFailures:"
      @errors.each do |error|
        puts "  - #{error}"
      end
      puts "\n❌ Some tests failed"
      exit 1
    else
      puts "\n✅ All tests passed!"
      exit 0
    end
  end
end

# Run tests
tester = GeneratorTester.new
tester.run
